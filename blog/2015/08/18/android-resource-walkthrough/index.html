
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Android Resource walkthrough - vicvan</title>
	<meta name="author" content="vicvan">

	
	<meta name="description" content="关于Android Resource这一块老罗博客有详细分析，并且罗老师的博客大家都懂的，质量很高。但是我还是决定把自己从
开发者的角度对这一块的理解记录下来，所以就有了这篇文章，本文章也来自于对罗老师博客的学习研究。 文章主要从 代码编写、代码编译、代码运行 三个阶段来分析。 代码编写阶段 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="vicvan" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">vicvan</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/project">Project</a></li>
	<li><a href="/me">Me</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/project">Project</a></li>
	<li><a href="/me">Me</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:fanhongwei.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:fanhongwei.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Android Resource Walkthrough</h2>
	<div class="entry-content"><blockquote>
<p>关于Android Resource这一块<a href="http://blog.csdn.net/luoshengyang/article/details/8738877">老罗博客</a>有详细分析，并且罗老师的博客大家都懂的，质量很高。但是我还是决定把自己从
开发者的角度对这一块的理解记录下来，所以就有了这篇文章，本文章也来自于对罗老师博客的学习研究。</p>
</blockquote>

<p>文章主要从 <strong>代码编写</strong>、<strong>代码编译</strong>、<strong>代码运行</strong> 三个阶段来分析。</p>

<h2>代码编写阶段</h2>

<p>首先我们来看Android应用资源分类,Android应用程序资源可以分为两大类，分别是assets和res。</p>

<ul>
<li>assets

<ul>
<li>assets类资源放在工程根目录的assets子目录下，它里面保存的是一些原始的文件，可以以任何方式来进行组织。这些文件最终会被原装不动地打包在apk文件中。如果我们要在程序中访问这些文件，那么
就需要指定文件名来访问。</li>
</ul></li>
</ul>

<!-- More-->

<ul>
<li>res

<ul>
<li>animator 这类资源以XML文件保存在res/animator目录下，用来描述属性动画。</li>
<li>anim 这类资源以XML文件保存在res/anim目录下，用来描述补间动画。</li>
<li>color 这类资源以XML文件保存在res/color目录下，用来描述对象颜色状态。</li>
<li>drawable(mipmap) 这类资源以XML或者Bitmap文件保存在res/drawable目录下，用来描述可绘制对象。</li>
<li>layout 这类资源以XML文件保存在res/layout目录下，用来描述应用程序界面布局。</li>
<li>menu 这类资源以XML文件保存在res/menu目录下，用来描述应用程序菜单.</li>
<li>raw 这类资源以任意格式的文件保存在res/raw目录下，它们和assets类资源一样，都是原装不动地打包在apk文件中的，不过它们会被赋予资源ID，这样我们就可以在程序中通过ID来访问它们。</li>
<li>values 这类资源以XML文件保存在res/values目录下，用来描述一些简单值，例如，数组、颜色、尺寸、字符串和样式值等，一般来说，这六种不同的值分别保存在名称为arrays.xml、colors.xml、
dimens.xml、strings.xml和styles.xml文件中。</li>
<li>xml 这类资源以XML文件保存在res/xml目录下，一般就是用来描述应用程序的配置信息。</li>
</ul></li>
</ul>

<p>我们在一般开发App过程中resource这一块主要就是操作这些文件夹，需要额外说的地方就是Android resource对于多分辨率、多语言、多版本、多屏幕等的支持。在这一块有一种说法就是Android默认应用程序资源的组织
方式有18个维度，当然如果从系统层次搞明白Android资源加载的话我们是可以自定义一些维度进去的。</p>

<table><thead>
<tr>
<th style="text-align: left">配置</th>
<th style="text-align: right">限定修饰词</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">MCC and MNC</td>
<td style="text-align: right">mcc310等</td>
</tr>
<tr>
<td style="text-align: left">language and region</td>
<td style="text-align: right">en、fr、en-rFR、zh等</td>
</tr>
<tr>
<td style="text-align: left">layout direction</td>
<td style="text-align: right">ldrtl、ldltr等</td>
</tr>
<tr>
<td style="text-align: left">smallestWidth</td>
<td style="text-align: right">sw320dp、sw600dp等</td>
</tr>
<tr>
<td style="text-align: left">available width</td>
<td style="text-align: right">w720dp、w1024dp等</td>
</tr>
<tr>
<td style="text-align: left">available height</td>
<td style="text-align: right">h720dp、h1024dp等</td>
</tr>
<tr>
<td style="text-align: left">screen size</td>
<td style="text-align: right">small、normal、large、xlarge等</td>
</tr>
<tr>
<td style="text-align: left">screen aspect</td>
<td style="text-align: right">long、notlong</td>
</tr>
<tr>
<td style="text-align: left">screen orientation</td>
<td style="text-align: right">port、land</td>
</tr>
<tr>
<td style="text-align: left">UI mode</td>
<td style="text-align: right">car、desk、television等</td>
</tr>
<tr>
<td style="text-align: left">night mode</td>
<td style="text-align: right">night、notnight</td>
</tr>
<tr>
<td style="text-align: left">screen pixel density</td>
<td style="text-align: right">ldpi、mdpi、hdpi、xhdpi等</td>
</tr>
<tr>
<td style="text-align: left">touchscreen type</td>
<td style="text-align: right">notouch、finger</td>
</tr>
<tr>
<td style="text-align: left">keyboard availability</td>
<td style="text-align: right">keysexposed、keyshidden、keysoft</td>
</tr>
<tr>
<td style="text-align: left">primary text input method</td>
<td style="text-align: right">nokeys、qwerty、12key</td>
</tr>
<tr>
<td style="text-align: left">navigation key availability</td>
<td style="text-align: right">navexposed、 navhidden</td>
</tr>
<tr>
<td style="text-align: left">primary non-touch navigation method</td>
<td style="text-align: right">nonav、dpad、trackball等</td>
</tr>
<tr>
<td style="text-align: left">platform version(API level)</td>
<td style="text-align: right">v14、v16、v21等</td>
</tr>
</tbody></table>

<h2>代码编译阶段</h2>

<p>Android resource资源是通过aapt(Android Asset Package Tool)打包到应用apk中的，在打包之前会做以下三件事情</p>

<ul>
<li>将类型为res/animator、res/anim、res/color、res/drawable（非Bitmap文件，即非.png、.9.png、.jpg、.gif文件）、res/layout、res/menu、res/values和res/xml的资源文件会从文
本格式的XML文件编译成二进制格式的XML文件。

<ul>
<li>二进制格式的XML文件占用空间更小。这是由于所有XML元素的标签、属性名称、属性值和内容所涉及到的字符串都会被统一收集到一个字符串资源池中去，并且会去重。有了这个字符串资源池，原来使用字符串的
地方就会被替换成一个索引到字符串资源池的整数值，从而可以减少文件的大小。</li>
<li>二进制格式的XML文件解析速度更快。这是由于二进制格式的XML元素里面不再包含有字符串值，因此就避免了进行字符串解析，从而提高速度。</li>
</ul></li>
<li>赋予每一个非assets资源一个ID值，这些ID值以常量的形式定义在R.java文件中。</li>
<li>生成一个resources.arsc文件，用来描述具有ID值的资源的配置信息，它的内容就相当于是一个资源索引表。</li>
</ul>

<p>接下来我们就按照Android资源打包工具的执行流程来分析</p>

<ul>
<li>解析AndroidManifest.xml

<ul>
<li>解析AndroidManifest.xml是为了得到应用程序的包名称，有了包名称就可以创建ResourceTable对象了。

<ul>
<li>ResourceTable用来总体描述一个资源表，具体ResourceTable可以在源码/frameworks/base/tools/aapt目录下找到。</li>
</ul></li>
</ul></li>
<li>添加被引用资源包

<ul>
<li>在原生Android中，编译应用程序资源的时候，一般会涉及到两个包，其中一个是被引用的系统资源包（Android系统编译的时候会在out/target/common/obj/APPS/framework-res_intermediates
目录下生成一个package-export.apk），另外一个就是当前正在编译的应用程序资源包。当然一些第三方定制ROM也会有自己的资源包，也会被添加进来。</li>
</ul></li>
<li>收集资源文件

<ul>
<li>在编译应用程序之前，Android资源打包工具aapt会创建一个AaptAssets对象，用来收集需要编译的资源文件。

<ul>
<li>AaptAssets类可以在/frameworks/base/tools/aapt目录下可以找到。</li>
<li>收集到的资源是按照类型来保存的，在AaptAssets中有一个ResourceTypeSet的变量在记录。</li>
</ul></li>
</ul></li>
<li>将收集到的资源增加到资源表

<ul>
<li>将上一步收集到的资源文件同时增加到资源表中，即第一步创建的ResourceTable对象。注意，这一步不会将values类型的资源收集到资源表。</li>
</ul></li>
<li>编译values类资源

<ul>
<li>values类型的资源是在编译的过程中收集的，也会同样添加到ResourceTable对象中。</li>
</ul></li>
<li>给Bag资源分配ID

<ul>
<li>values类型的资源，如string、bag、style、plurals和array类的资源。这些资源会给自己定义一些专用的值，这些带有专用值的资源就统称为Bag资源。
在继续编译其它非values的资源之前，需要给之前收集到的Bag资源分配资源ID，因为它们可能会被其它非values类资源引用到。</li>
</ul></li>
<li>编译xml资源文件

<ul>
<li>这一步会编译除了values类型的所有资源。这一块比较繁杂，如果有兴趣可以单独研究，我就大概看了下。

<ul>
<li>解析xml文件</li>
<li>赋予属性名称资源ID</li>
<li>解析属性值</li>
<li>将xml文件转换为二进制格式</li>
<li>收集有资源ID的属性的名称字符串</li>
<li>收集其他字符串</li>
<li>写入xml文件头</li>
<li>写入字符串资源池</li>
<li>写入资源ID</li>
<li>将xml文件里边的字符串替换掉</li>
</ul></li>
</ul></li>
<li>生成资源符号

<ul>
<li>Android资源打包工具aapt只要遍历每一个ResourceTable对象里边的type，并根据entry的名称以及出现的次序来计算的到资源ID。</li>
</ul></li>
<li>生成资源索引表

<ul>
<li>这个过程就是生成resources.arsc的过程

<ul>
<li>收集类型字符串</li>
<li>收集资源项名称字符串</li>
<li>收集资源项值字符串</li>
<li>生成Package数据块（这一块同样略复杂）

<ul>
<li>写入Package资源项元信息数据块头部,这一块有一个比较注意的点就是，类似于Android或者第三方定制rom会在resource里边定义public标签的属性之，这个地方是为了保证不论何时编译，这些
属性值ID的唯一性。</li>
<li>写入字符串资源池</li>
<li>写入资源项名称字符串资源池</li>
<li>写入类型规范数据块</li>
<li>写入类型资源项数据块</li>
</ul></li>
<li>写入资源索引表头部</li>
<li>写入资源项的字符串资源池</li>
<li>写入Package数据块</li>
</ul></li>
</ul></li>
<li>编译AndroidManifest.xml

<ul>
<li>当前边步骤都进行完之后就会把AndroidManifest.xml也编译成二进制格式的xml文件，之所以要在应用程序的所有资源都编译完成之后再编译AndroidManifest，是因为后者可能会引用前者。</li>
</ul></li>
<li>生成R.java文件

<ul>
<li>前边步骤已经将所有资源以及对应的ID都收集起来了，直接写入到R.java中即可。</li>
</ul></li>
<li>打包APK文件

<ul>
<li>assets目录打包进apk</li>
<li>res目录打包进apk，除了res/values，因为values目录下的资源在编译的过程中都直接写入到资源索引表中去了，这也是为什么values类型资源会单独编译的原因。</li>
<li>资源索引文件resources.arsc打包进apk</li>
<li>AndroidManifest.xml打包进apk</li>
<li>其他文件打包进apk，比如class.dex、签名等。</li>
</ul></li>
</ul>

<h2>代码运行阶段　</h2>

<p>在代码运行阶段主要是通过AssetManager和Resources两个类来完成资源的加载的。Resources类根据ID（ID来源于之前生成并打包进apk的resources.arsc文件）来查找资源，AssetManager根据文件
名来查找资源。我们同样以一个Activity OnCreate的流程来分析</p>

<ul>
<li>Activity.setContentView
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Set the activity content from a layout resource.  The resource will be</span>
</span><span class='line'><span class="cm">     * inflated, adding all top-level views to the activity.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @param layoutResID Resource ID to be inflated.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @see #setContentView(android.view.View)</span>
</span><span class='line'><span class="cm">     * @see #setContentView(android.view.View, android.view.ViewGroup.LayoutParams)</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentView</span><span class="o">(</span><span class="kt">int</span> <span class="n">layoutResID</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">getWindow</span><span class="o">().</span><span class="na">setContentView</span><span class="o">(</span><span class="n">layoutResID</span><span class="o">);</span>
</span><span class='line'>        <span class="n">initWindowDecorActionBar</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></li>
<li>PhoneWindow.setContentView
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentView</span><span class="o">(</span><span class="kt">int</span> <span class="n">layoutResID</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Note: FEATURE<em>CONTENT</em>TRANSITIONS may be set in the process of installing the window</span>
</span><span class='line'>        <span class="c1">// decor, when theme attributes and the like are crystalized. Do not check the feature</span>
</span><span class='line'>        <span class="c1">// before this happens.</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mContentParent</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">installDecor</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">hasFeature</span><span class="o">(</span><span class="n">FEATURE<em>CONTENT</em>TRANSITIONS</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mContentParent</span><span class="o">.</span><span class="na">removeAllViews</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">hasFeature</span><span class="o">(</span><span class="n">FEATURE<em>CONTENT</em>TRANSITIONS</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">final</span> <span class="n">Scene</span> <span class="n">newScene</span> <span class="o">=</span> <span class="n">Scene</span><span class="o">.</span><span class="na">getSceneForLayout</span><span class="o">(</span><span class="n">mContentParent</span><span class="o">,</span> <span class="n">layoutResID</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">getContext</span><span class="o">());</span>
</span><span class='line'>            <span class="n">transitionTo</span><span class="o">(</span><span class="n">newScene</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mLayoutInflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">layoutResID</span><span class="o">,</span> <span class="n">mContentParent</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">Callback</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">getCallback</span><span class="o">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">cb</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isDestroyed</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">cb</span><span class="o">.</span><span class="na">onContentChanged</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></li>
<li>LayoutInflater.inflate
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Inflate a new view hierarchy from the specified xml resource. Throws</span>
</span><span class='line'><span class="cm">     * {@link InflateException} if there is an error.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @param resource ID for an XML layout resource to load (e.g.,</span>
</span><span class='line'><span class="cm">     *        &lt;code&gt;R.layout.main_page&lt;/code&gt;)</span>
</span><span class='line'><span class="cm">     * @param root Optional view to be the parent of the generated hierarchy (if</span>
</span><span class='line'><span class="cm">     *        &lt;em&gt;attachToRoot&lt;/em&gt; is true), or else simply an object that</span>
</span><span class='line'><span class="cm">     *        provides a set of LayoutParams values for root of the returned</span>
</span><span class='line'><span class="cm">     *        hierarchy (if &lt;em&gt;attachToRoot&lt;/em&gt; is false.)</span>
</span><span class='line'><span class="cm">     * @param attachToRoot Whether the inflated hierarchy should be attached to</span>
</span><span class='line'><span class="cm">     *        the root parameter? If false, root is only used to create the</span>
</span><span class='line'><span class="cm">     *        correct subclass of LayoutParams for the root view in the XML.</span>
</span><span class='line'><span class="cm">     * @return The root View of the inflated hierarchy. If root was supplied and</span>
</span><span class='line'><span class="cm">     *         attachToRoot is true, this is root; otherwise it is the root of</span>
</span><span class='line'><span class="cm">     *         the inflated XML file.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">View</span> <span class="nf">inflate</span><span class="o">(</span><span class="kt">int</span> <span class="n">resource</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">root</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">attachToRoot</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">Resources</span> <span class="n">res</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getResources</span><span class="o">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;INFLATING from resource: &amp;quot;&quot;</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="na">getResourceName</span><span class="o">(</span><span class="n">resource</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;&amp;quot; (&quot;</span>
</span><span class='line'>                    <span class="o">+</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">resource</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">final</span> <span class="n">XmlResourceParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getLayout</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nf">inflate</span><span class="o">(</span><span class="n">parser</span><span class="o">,</span> <span class="n">root</span><span class="o">,</span> <span class="n">attachToRoot</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">parser</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<ul>
<li>最终调用到了Resource.getLayout</li>
</ul></li>
<li>Resources.getLayout
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Return an XmlResourceParser through which you can read a view layout</span>
</span><span class='line'><span class="cm">     * description for the given resource ID.  This parser has limited</span>
</span><span class='line'><span class="cm">     * functionality -- in particular, you can&#39;t change its input, and only</span>
</span><span class='line'><span class="cm">     * the high-level events are available.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * &lt;p&gt;This function is really a simple wrapper for calling</span>
</span><span class='line'><span class="cm">     * {@link #getXml} with a layout resource.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @param id The desired resource identifier, as generated by the aapt</span>
</span><span class='line'><span class="cm">     *           tool. This integer encodes the package, type, and resource</span>
</span><span class='line'><span class="cm">     *           entry. The value 0 is an invalid identifier.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @throws NotFoundException Throws NotFoundException if the given ID does not exist.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @return A new parser object through which you can read</span>
</span><span class='line'><span class="cm">     *         the XML data.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @see #getXml</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">XmlResourceParser</span> <span class="nf">getLayout</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NotFoundException</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">loadXmlResourceParser</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="s">&quot;layout&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></li>
<li>Resources.loadXmlResourceParser</li>
<li>Resources.getValue</li>
<li>AssetManager.getResourceValue</li>
<li>AssetManager.loadResourceValue

<ul>
<li>这是一个native方法，对应到android<em>content</em>AssetManager<em>loadResourceValue函数，这个函数定义在文件frameworks/base/core/jni/android</em>util_AssetManager.cpp中。
得到的资源项值及其配置信息拷贝到参数outValue所描述的一个Java层的TypedValue对象中。这个地方会有一个ResTable的对象用来记录一系列数据。</li>
</ul></li>
<li>AssetManager.getResources

<ul>
<li>AssetManager类的成员函数getResources的实现看起来比较复杂，但是它要做的事情就是解析当前应用程序所使用的资源包里面的resources.arsc文件。</li>
</ul></li>
<li>ResTable.getResource

<ul>
<li>根据之前AssetManager.loadResourceValue得到的各种信息，在上一步解析resources.arsc得到的数据中get到相应的value值。这一块的逻辑处理非常复杂，我并没有深入研究下去。</li>
</ul></li>
<li>ResTable.resolveReference

<ul>
<li>ResTable类的成员函数resolveReference的实现其实很简单，它就是对参数value所描述的一个资源项值进行解析。</li>
</ul></li>
<li>Resources.loadXmlResourceParser
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/<em>package</em>/</span> <span class="n">XmlResourceParser</span> <span class="nf">loadXmlResourceParser</span><span class="o">(</span><span class="n">String</span> <span class="n">file</span><span class="o">,</span> <span class="kt">int</span> <span class="n">id</span><span class="o">,</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">assetCookie</span><span class="o">,</span> <span class="n">String</span> <span class="n">type</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NotFoundException</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// These may be compiled...</span>
</span><span class='line'>                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mCachedXmlBlockIds</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="c1">// First see if this block is in our cache.</span>
</span><span class='line'>                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">mCachedXmlBlockIds</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span><span class='line'>                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="k">if</span> <span class="o">(</span><span class="n">mCachedXmlBlockIds</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">==</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                            <span class="c1">//System.out.println(&quot;**** REUSING XML BLOCK!  id=&quot;</span>
</span><span class='line'>                            <span class="c1">//                   + id + &quot;, index=&quot; + i);</span>
</span><span class='line'>                            <span class="k">return</span> <span class="n">mCachedXmlBlocks</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">newParser</span><span class="o">();</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                    <span class="c1">// Not in the cache, create a new block and put it at</span>
</span><span class='line'>                    <span class="c1">// the next slot in the cache.</span>
</span><span class='line'>                    <span class="n">XmlBlock</span> <span class="n">block</span> <span class="o">=</span> <span class="n">mAssets</span><span class="o">.</span><span class="na">openXmlBlockAsset</span><span class="o">(</span>
</span><span class='line'>                            <span class="n">assetCookie</span><span class="o">,</span> <span class="n">file</span><span class="o">);</span>
</span><span class='line'>                    <span class="k">if</span> <span class="o">(</span><span class="n">block</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">mLastCachedXmlBlockIndex</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>
</span><span class='line'>                        <span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="o">)</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>                        <span class="n">mLastCachedXmlBlockIndex</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
</span><span class='line'>                        <span class="n">XmlBlock</span> <span class="n">oldBlock</span> <span class="o">=</span> <span class="n">mCachedXmlBlocks</span><span class="o">[</span><span class="n">pos</span><span class="o">];</span>
</span><span class='line'>                        <span class="k">if</span> <span class="o">(</span><span class="n">oldBlock</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                            <span class="n">oldBlock</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                        <span class="n">mCachedXmlBlockIds</span><span class="o">[</span><span class="n">pos</span><span class="o">]</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>                        <span class="n">mCachedXmlBlocks</span><span class="o">[</span><span class="n">pos</span><span class="o">]</span> <span class="o">=</span> <span class="n">block</span><span class="o">;</span>
</span><span class='line'>                        <span class="c1">//System.out.println(&quot;**** CACHING NEW XML BLOCK!  id=&quot;</span>
</span><span class='line'>                        <span class="c1">//                   + id + &quot;, index=&quot; + pos);</span>
</span><span class='line'>                        <span class="k">return</span> <span class="n">block</span><span class="o">.</span><span class="na">newParser</span><span class="o">();</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">NotFoundException</span> <span class="n">rnf</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">NotFoundException</span><span class="o">(</span>
</span><span class='line'>                        <span class="s">&quot;File &quot;</span> <span class="o">+</span> <span class="n">file</span> <span class="o">+</span> <span class="s">&quot; from xml type &quot;</span> <span class="o">+</span> <span class="n">type</span> <span class="o">+</span> <span class="s">&quot; resource ID #0x&quot;</span>
</span><span class='line'>                        <span class="o">+</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">id</span><span class="o">));</span>
</span><span class='line'>                <span class="n">rnf</span><span class="o">.</span><span class="na">initCause</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>                <span class="k">throw</span> <span class="n">rnf</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotFoundException</span><span class="o">(</span>
</span><span class='line'>                <span class="s">&quot;File &quot;</span> <span class="o">+</span> <span class="n">file</span> <span class="o">+</span> <span class="s">&quot; from xml type &quot;</span> <span class="o">+</span> <span class="n">type</span> <span class="o">+</span> <span class="s">&quot; resource ID #0x&quot;</span>
</span><span class='line'>                <span class="o">+</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">id</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></li>
<li>AssetManager.openXmlBlockAsset
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/*<em></span>
</span><span class='line'><span class="cm">     * {@hide}</span>
</span><span class='line'><span class="cm">     * Retrieve a non-asset as a compiled XML file.  Not for use by</span>
</span><span class='line'><span class="cm">     * applications.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @param cookie Identifier of the package to be opened.</span>
</span><span class='line'><span class="cm">     * @param fileName Name of the asset to retrieve.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="cm">/</em>package*/</span> <span class="kd">final</span> <span class="n">XmlBlock</span> <span class="nf">openXmlBlockAsset</span><span class="o">(</span><span class="kt">int</span> <span class="n">cookie</span><span class="o">,</span> <span class="n">String</span> <span class="n">fileName</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(!</span><span class="n">mOpen</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Assetmanager has been closed&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">xmlBlock</span> <span class="o">=</span> <span class="n">openXmlAssetNative</span><span class="o">(</span><span class="n">cookie</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">xmlBlock</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">XmlBlock</span> <span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">XmlBlock</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">xmlBlock</span><span class="o">);</span>
</span><span class='line'>                <span class="n">incRefsLocked</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">FileNotFoundException</span><span class="o">(</span><span class="s">&quot;Asset XML file: &quot;</span> <span class="o">+</span> <span class="n">fileName</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></li>
<li>AssetManager.openXmlAssetNative</li>
</ul>

<p>...</p>

<p>这中间有一系列的native方法调用</p>

<ul>
<li>LayoutInflater.inflate

<ul>
<li>这一步根据之前得到的Parser对象来继续进行</li>
</ul></li>
<li>LayoutInflater.createViewFromTag

<ul>
<li>根据应用的属性值得到一个view</li>
</ul></li>
<li>PhoneLayoutInflater.onCreateView</li>
<li>LayoutInflater.createView</li>
</ul>

<p>这一块会有一个疑问，应用是如何找到Android系统资源的？在之前提到的编译阶段，系统提供的apk资源包的资源也会被收集进来，那么运行阶段是如何找到的呢？</p>

<p>系统的资源打包在/system/framework/framework-res.apk文件中，它在应用程序进程中是通过一个单独的Resources对象和一个单独的AssetManager对象来管理的。这个单独的Resources
对象就保存在Resources类的静态成员变量mSystem中，我们可以通过Resources类的静态成员函数getSystem就可以获得这个Resources对象，而这个单独的AssetManager对象就保存在AssetManager
类的静态成员变量sSystem中，我们可以通过AssetManager类的静态成员函数getSystem同样可以获得这个AssetManager对象。</p>
</div>


<div class="meta">
	<div class="date">




Aug 18th, 2015</div>
	<div class="tags">


	<a class='category' href='/blog/categories/android/'>android</a>


</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    vicvan

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>